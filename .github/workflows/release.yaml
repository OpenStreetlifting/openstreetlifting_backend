name: deploy container image

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Semantic version (e.g., 1.0.0)"
        required: true
        type: string

env:
  DOCKER_IMAGE: dirdros/openstreetlifting_backend
  REGISTRY: docker.io

jobs:
  verify-ci:
    name: Verify CI passed
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check CI status
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Checking if CI passed on main branch..."

          # Get the latest commit on main
          MAIN_SHA=$(git rev-parse origin/main)
          echo "Latest main commit: $MAIN_SHA"

          # Check if we're releasing from main
          CURRENT_SHA=$(git rev-parse HEAD)
          if [ "$CURRENT_SHA" != "$MAIN_SHA" ]; then
            echo "Warning: Current commit is not the latest on main"
            echo "Current: $CURRENT_SHA"
            echo "Main: $MAIN_SHA"
          fi

          # Wait for CI to complete and check status
          gh run list --workflow=ci.yml --branch=main --limit=1 --json conclusion,status,headSha --jq '.[0]' > ci-status.json

          CI_SHA=$(jq -r '.headSha' ci-status.json)
          CI_STATUS=$(jq -r '.status' ci-status.json)
          CI_CONCLUSION=$(jq -r '.conclusion' ci-status.json)

          echo "CI Status: $CI_STATUS"
          echo "CI Conclusion: $CI_CONCLUSION"

          if [ "$CI_STATUS" != "completed" ]; then
            echo "Error: CI is still running or has not started. Wait for CI to complete."
            exit 1
          fi

          if [ "$CI_CONCLUSION" != "success" ]; then
            echo "Error: CI did not pass. Fix CI errors before releasing."
            exit 1
          fi

          echo "âœ“ CI passed successfully on main"

  release:
    needs: [verify-ci]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate semver format
        run: |
          if ! echo "${{ inputs.version }}" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9\.]+)?(\+[a-zA-Z0-9\.]+)?$'; then
            echo "Error: Invalid semantic version format. Expected format: X.Y.Z"
            exit 1
          fi

      - name: Create and push tag
        id: create_tag
        run: |
          git fetch --tags

          if git rev-parse "v${{ inputs.version }}" >/dev/null 2>&1; then
            echo "Tag v${{ inputs.version }} already exists, skipping tag creation"
            echo "created=false" >> $GITHUB_OUTPUT
          else
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git tag -a "v${{ inputs.version }}" -m "Release v${{ inputs.version }}"
            git push origin "v${{ inputs.version }}"
            echo "Created and pushed tag v${{ inputs.version }}"
            echo "created=true" >> $GITHUB_OUTPUT
          fi

      - name: Generate changelog
        id: changelog
        uses: mikepenz/release-changelog-builder-action@v4
        with:
          configuration: .github/changelog-config.json
          toTag: v${{ inputs.version }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update CHANGELOG.md
        run: |
          # Get current date
          RELEASE_DATE=$(date +%Y-%m-%d)

          # Create new changelog entry
          NEW_ENTRY="## [${{ inputs.version }}] - $RELEASE_DATE\n\n${{ steps.changelog.outputs.changelog }}\n"

          # Insert after [Unreleased] section
          sed -i.bak "/## \[Unreleased\]/a\\
          \\
          $NEW_ENTRY" CHANGELOG.md

          rm CHANGELOG.md.bak

          # Update comparison links at bottom
          REPO_URL="https://github.com/${{ github.repository }}"
          sed -i.bak "s|\[Unreleased\]:.*|[Unreleased]: $REPO_URL/compare/v${{ inputs.version }}...HEAD|" CHANGELOG.md
          echo "[${{ inputs.version }}]: $REPO_URL/compare/v${{ github.event.before }}...v${{ inputs.version }}" >> CHANGELOG.md

          rm CHANGELOG.md.bak

      - name: Commit CHANGELOG.md
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add CHANGELOG.md
          git commit -m "chore: update CHANGELOG for v${{ inputs.version }}" || echo "No changes to commit"
          git push origin main || echo "Nothing to push"

      - name: Create GitHub Release
        id: create_release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if release already exists
          if gh release view "v${{ inputs.version }}" >/dev/null 2>&1; then
            echo "Release v${{ inputs.version }} already exists, skipping release creation"
            echo "created=false" >> $GITHUB_OUTPUT
          else
            # Create the release
            PRERELEASE_FLAG=""
            if [[ "${{ inputs.version }}" == *"-"* ]]; then
              PRERELEASE_FLAG="--prerelease"
            fi

            gh release create "v${{ inputs.version }}" \
              --title "Release v${{ inputs.version }}" \
              --notes "${{ steps.changelog.outputs.changelog }}" \
              $PRERELEASE_FLAG

            echo "Created release v${{ inputs.version }}"
            echo "created=true" >> $GITHUB_OUTPUT
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_IMAGE }}
          tags: |
            type=semver,pattern={{version}},value=v${{ inputs.version }}
            type=semver,pattern={{major}}.{{minor}},value=v${{ inputs.version }}
            type=semver,pattern={{major}},value=v${{ inputs.version }}
            type=raw,value=latest,enable=${{ !contains(inputs.version, '-') }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64
